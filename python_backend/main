"""
FastAPI Backend for The Eleventh Beast Game
Provides REST API endpoints for the frontend to communicate with Python game engine
"""

from fastapi import FastAPI, HTTPException, Depends
from fastapi.middleware.cors import CORSMiddleware
from fastapi.staticfiles import StaticFiles
from pydantic import BaseModel
from typing import Dict, Optional, List
import uuid

from game_engine import (
    GameEngine, 
    create_game, 
    get_game, 
    game_sessions,
    LOCATIONS,
    LOCATION_CONNECTIONS
)

app = FastAPI(title="The Eleventh Beast Game API", version="1.0.0")

# Enable CORS for frontend communication
app.add_middleware(
    CORSMiddleware,
    allow_origins=["http://localhost:3000", "http://localhost:5173", "http://localhost:8080"],  # Common dev ports
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)

# Request/Response Models
class CreateGameRequest(BaseModel):
    beast_name: str
    inquisitor_name: str
    seed: Optional[int] = None

class GameActionRequest(BaseModel):
    session_id: str
    action_type: str  # "move", "investigate", "verify", "hunt", "complete_action"
    target_location: Optional[str] = None

class GameResponse(BaseModel):
    success: bool
    message: str
    game_data: Optional[Dict] = None
    game_log: Optional[List[Dict]] = None
    locations: Optional[List[Dict]] = None
    location_connections: Optional[Dict] = None

# API Endpoints

@app.get("/")
async def root():
    return {"message": "The Eleventh Beast Game API is running", "version": "1.0.0"}

@app.post("/api/games", response_model=GameResponse)
async def create_new_game(request: CreateGameRequest):
    """Create a new game session"""
    try:
        session_id = create_game(request.beast_name, request.inquisitor_name, request.seed)
        game_engine = get_game(session_id)
        
        if not game_engine:
            raise HTTPException(status_code=500, detail="Failed to create game")
        
        state = game_engine.get_game_state()
        
        return GameResponse(
            success=True,
            message="Game created successfully",
            game_data={
                **state["game_data"],
                "session_id": session_id  # Include session ID in response
            },
            game_log=state["game_log"],
            locations=state["locations"],
            location_connections=state["location_connections"]
        )
    
    except Exception as e:
        raise HTTPException(status_code=500, detail=str(e))

@app.get("/api/games/{session_id}", response_model=GameResponse)
async def get_game_state(session_id: str):
    """Get current game state"""
    game_engine = get_game(session_id)
    
    if not game_engine:
        raise HTTPException(status_code=404, detail="Game session not found")
    
    state = game_engine.get_game_state()
    
    return GameResponse(
        success=True,
        message="Game state retrieved",
        game_data=state["game_data"],
        game_log=state["game_log"],
        locations=state["locations"],
        location_connections=state["location_connections"]
    )

@app.post("/api/games/action", response_model=GameResponse)
async def perform_game_action(request: GameActionRequest):
    """Perform a game action"""
    game_engine = get_game(request.session_id)
    
    if not game_engine:
        raise HTTPException(status_code=404, detail="Game session not found")
    
    try:
        if request.action_type == "move":
            if not request.target_location:
                raise HTTPException(status_code=400, detail="Target location required for move action")
            
            result = game_engine.move_player(request.target_location)
        
        elif request.action_type == "investigate":
            result = game_engine.investigate()
        
        elif request.action_type == "verify":
            result = game_engine.verify_rumors()
        
        elif request.action_type == "hunt":
            result = game_engine.hunt_beast()
        
        elif request.action_type == "complete_action":
            result = game_engine.complete_action()
        
        else:
            raise HTTPException(status_code=400, detail=f"Unknown action type: {request.action_type}")
        
        # Add session_id to game_data in response
        if result.get("game_data"):
            result["game_data"]["session_id"] = request.session_id
        
        return GameResponse(**result)
    
    except HTTPException:
        raise
    except Exception as e:
        raise HTTPException(status_code=500, detail=str(e))

@app.get("/api/locations")
async def get_locations():
    """Get all game locations and connections"""
    return {
        "success": True,
        "locations": [loc.__dict__ for loc in LOCATIONS],
        "location_connections": LOCATION_CONNECTIONS
    }

@app.delete("/api/games/{session_id}")
async def delete_game(session_id: str):
    """Delete a game session"""
    if session_id in game_sessions:
        del game_sessions[session_id]
        return {"success": True, "message": "Game session deleted"}
    else:
        raise HTTPException(status_code=404, detail="Game session not found")

@app.get("/api/games")
async def list_games():
    """List all active game sessions"""
    return {
        "success": True,
        "sessions": list(game_sessions.keys()),
        "count": len(game_sessions)
    }

if __name__ == "__main__":
    import uvicorn
    uvicorn.run(app, host="0.0.0.0", port=8000, reload=True)